#!/bin/bash
#
# Pre-commit hook to prevent accidental commit of secrets
# Install: cp hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
#

set -e

RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Patterns that indicate secrets (case insensitive)
SECRET_PATTERNS=(
    # GitHub tokens
    'ghp_[a-zA-Z0-9]{36}'
    'github_pat_[a-zA-Z0-9_]{22,}'
    'gho_[a-zA-Z0-9]{36}'
    'ghu_[a-zA-Z0-9]{36}'
    'ghs_[a-zA-Z0-9]{36}'
    'ghr_[a-zA-Z0-9]{36}'
    # OpenAI
    'sk-[a-zA-Z0-9]{48}'
    # Anthropic
    'sk-ant-[a-zA-Z0-9-]{80,}'
    # AWS
    'AKIA[0-9A-Z]{16}'
    # Generic API keys
    'api[_-]?key["\s:=]+["\047][a-zA-Z0-9]{20,}["\047]'
    # Private keys
    '-----BEGIN (RSA |DSA |EC |OPENSSH )?PRIVATE KEY-----'
    # YouTube cookies
    'APISID|SAPISID|__Secure-'
)

# Files to always skip
SKIP_FILES=(
    '.env.example'
    'pre-commit'
    '*.md'
)

found_secrets=false

# Get staged files
staged_files=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || true)

if [ -z "$staged_files" ]; then
    exit 0
fi

for file in $staged_files; do
    # Skip certain files
    skip=false
    for pattern in "${SKIP_FILES[@]}"; do
        if [[ "$file" == $pattern ]]; then
            skip=true
            break
        fi
    done
    [ "$skip" = true ] && continue

    # Skip binary files
    if file "$file" 2>/dev/null | grep -q "binary"; then
        continue
    fi

    # Check each pattern
    for pattern in "${SECRET_PATTERNS[@]}"; do
        if git diff --cached "$file" 2>/dev/null | grep -qiE "$pattern"; then
            echo -e "${RED}[BLOCKED]${NC} Potential secret found in: $file"
            echo -e "${YELLOW}Pattern:${NC} $pattern"
            found_secrets=true
        fi
    done
done

if [ "$found_secrets" = true ]; then
    echo ""
    echo -e "${RED}Commit blocked: potential secrets detected${NC}"
    echo "Review the files above and remove sensitive data."
    echo ""
    echo "To bypass this check (NOT recommended):"
    echo "  git commit --no-verify"
    exit 1
fi

exit 0
